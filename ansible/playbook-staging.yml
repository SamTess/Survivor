- name: Deploy Staging Environment
  hosts: survivor_staging
  vars_files:
    - config.yml
  tags:
    - deploy
    - staging
  vars:
    deploy_env: "staging"
    git_branch: "{{ repository.git_branch_staging }}"
    compose_file: "{{ docker.staging_compose_file }}"
    app_port: "{{ docker.staging_port }}"
    env_file: "{{ env_files.staging_env_file }}"
  tasks:
    - name: Create application directory
      file:
        path: "{{ repository.app_directory }}"
        state: directory
        mode: '0755'

    - name: Clone/Update repository (staging branch)
      git:
        repo: "{{ repository.git_url }}"
        dest: "{{ repository.app_directory }}"
        version: "{{ git_branch }}"
        depth: 1
        force: yes
        update: yes
      register: git_clone_staging

    - name: Copy staging environment file
      template:
        src: "{{ env_file }}.j2"
        dest: "{{ repository.app_directory }}/Docker/.env"
        mode: '0644'
        backup: yes
      when: env_file is defined
      register: env_file_staging
      ignore_errors: yes

    - name: Check if docker-compose file exists
      stat:
        path: "{{ repository.app_directory }}/Docker/{{ compose_file }}"
      register: compose_file_check_staging

    - name: Debug - Show compose file check result
      debug:
        msg: |
          Compose file path: {{ repository.app_directory }}/Docker/{{ compose_file }}
          File exists: {{ compose_file_check_staging.stat.exists | default('undefined') }}
          Looking for: docker-compose.https.yml

    - name: Debug - List Docker directory contents
      find:
        paths: "{{ repository.app_directory }}/Docker"
        file_type: file
      register: docker_dir_files
      ignore_errors: yes

    - name: Debug - Show all files in Docker directory
      debug:
        msg: "Files found: {{ docker_dir_files.files | map(attribute='path') | list }}"
      when: docker_dir_files.files is defined

    - name: Stop existing Docker containers (staging)
      community.docker.docker_compose_v2:
        project_src: "{{ repository.app_directory }}/Docker"
        files:
          - "{{ compose_file }}"
        state: absent
        remove_orphans: yes
      when: compose_file_check_staging.stat.exists
      ignore_errors: yes

    - name: Build and start Docker containers (staging)
      community.docker.docker_compose_v2:
        project_src: "{{ repository.app_directory }}/Docker"
        files:
          - "docker-compose.https.yml"
        build: always
        state: present
        recreate: always
        remove_orphans: yes
      when: compose_file_check_staging.stat.exists
      register: staging_deploy_result

    - name: Wait for database to be ready (staging)
      pause:
        seconds: 15
      when: compose_file_check_staging.stat.exists

    - name: Check if migration files exist (staging)
      command: docker compose -f docker-compose.https.yml exec -T web sh -c "ls -la prisma/migrations/ 2>/dev/null | wc -l"
      args:
        chdir: "{{ repository.app_directory }}/Docker"
      when: compose_file_check_staging.stat.exists
      register: staging_migration_files_check
      ignore_errors: yes

    - name: Create database schema from Prisma schema (staging - first time)
      command: docker compose -f docker-compose.https.yml exec -T web npx prisma db push --accept-data-loss
      args:
        chdir: "{{ repository.app_directory }}/Docker"
      when:
        - compose_file_check_staging.stat.exists
        - staging_migration_files_check.stdout is defined
        - staging_migration_files_check.stdout | int <= 2
      register: staging_db_push_result
      ignore_errors: yes

    - name: Run Prisma database migration (staging - if migrations exist)
      command: docker compose -f docker-compose.https.yml exec -T web npx prisma migrate deploy
      args:
        chdir: "{{ repository.app_directory }}/Docker"
      when:
        - compose_file_check_staging.stat.exists
        - staging_migration_files_check.stdout is defined
        - staging_migration_files_check.stdout | int > 2
      register: staging_migration_result
      ignore_errors: yes

    - name: Generate Prisma client (staging)
      command: docker compose -f docker-compose.https.yml exec -T web npx prisma generate
      args:
        chdir: "{{ repository.app_directory }}/Docker"
      when: compose_file_check_staging.stat.exists
      register: staging_generate_result
      ignore_errors: yes

    - name: Display migration status (staging)
      debug:
        msg: |
          Staging migration status:
          {% if staging_db_push_result is defined and staging_db_push_result.rc is defined %}
          DB Push (first time): {{ 'SUCCESS' if staging_db_push_result.rc == 0 else 'FAILED' }}
          {% if staging_db_push_result.rc != 0 %}
          DB Push error: {{ staging_db_push_result.stderr | default('Unknown error') }}
          {% endif %}
          {% elif staging_db_push_result is defined %}
          DB Push (first time): SKIPPED or FAILED (no rc)
          {% else %}
          DB Push (first time): NOT RUN
          {% endif %}
          {% if staging_migration_result is defined and staging_migration_result.rc is defined %}
          Migration: {{ 'SUCCESS' if staging_migration_result.rc == 0 else 'FAILED' }}
          {% if staging_migration_result.rc != 0 %}
          Migration error: {{ staging_migration_result.stderr | default('Unknown error') }}
          {% endif %}
          {% elif staging_migration_result is defined %}
          Migration: SKIPPED or FAILED (no rc)
          {% else %}
          Migration: NOT RUN
          {% endif %}
          {% if staging_generate_result is defined and staging_generate_result.rc is defined %}
          Generate: {{ 'SUCCESS' if staging_generate_result.rc == 0 else 'FAILED' }}
          {% if staging_generate_result.rc != 0 %}
          Generate error: {{ staging_generate_result.stderr | default('Unknown error') }}
          {% endif %}
          {% elif staging_generate_result is defined %}
          Generate: SKIPPED or FAILED (no rc)
          {% else %}
          Generate: NOT RUN
          {% endif %}
      when: compose_file_check_staging.stat.exists

    - name: Wait for staging application to be ready
      uri:
        url: "https://survivooooor.duckdns.org/health"
        method: GET
        status_code: 200
        timeout: 10
        validate_certs: no
      register: staging_health_check
      until: staging_health_check.status == 200
      retries: 30
      delay: 10
      when: compose_file_check_staging.stat.exists
      ignore_errors: yes

    - name: Check if staging containers are running (fallback health check)
      command: docker ps --filter "name={{ application.app_name }}" --format "table {% raw %}{{.Names}}\t{{.Status}}{% endraw %}"
      register: staging_container_status
      when: staging_health_check is failed or staging_health_check is skipped
      changed_when: false

    - name: Display staging deployment status
      debug:
        msg: |
          Staging deployment completed!
          URL: https://survivooooor.duckdns.org
          Branch: {{ git_branch }}
          Health check: {{ 'PASSED' if (staging_health_check.status is defined and staging_health_check.status == 200) else 'FAILED/SKIPPED' }}
          {% if staging_container_status is defined and staging_container_status.stdout is defined %}
          Container status: {{ staging_container_status.stdout }}
          {% endif %}

    - name: Check if staging containers are running before API call
      command: docker ps --format "{% raw %}{{.Names}}\t{{.Status}}{% endraw %}"
      register: staging_running_check
      when: staging_deploy_result is defined
      changed_when: false

    - name: Force external data sync via API
      uri:
        url: "https://survivooooor.duckdns.org/api/sync/external"
        method: POST
        body_format: json
        body: "{}"
        headers:
          Content-Type: "application/json"
        status_code: [200, 201, 202]
        timeout: 30
        validate_certs: no
      register: sync_api_result
      when:
        - staging_deploy_result is defined
        - staging_running_check.stdout is defined
        - staging_running_check.stdout != ""
        - "'Up' in staging_running_check.stdout or 'healthy' in staging_running_check.stdout"
      ignore_errors: yes

    - name: Display sync API result
      debug:
        msg: |
          External sync API call result:
          {% if sync_api_result is defined and sync_api_result.status is defined %}
          Status: {{ sync_api_result.status }}
          Response: {{ sync_api_result.json | default('No JSON response') }}
          {% elif sync_api_result is defined %}
          Result: FAILED - {{ sync_api_result.msg | default('Unknown error') }}
          {% else %}
          Result: SKIPPED (containers not running or deployment unchanged)
          {% endif %}
      when: staging_deploy_result is defined
